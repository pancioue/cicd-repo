# cloudbuild.yaml (UI manual run friendly)
# ç›®æ¨™ï¼šUI æ‰‹å‹• Runï¼ˆé è¨­ mainï¼‰ä¹Ÿèƒ½éƒ¨ç½²ï¼Œä¸ä¾è³´ TAG_NAME
# æµç¨‹ï¼šno-traffic deployï¼ˆcanary tagï¼‰â†’ smoke test(/up) â†’ promote traffic to latest
# âœ… åŠ å…¥å¯é¸ Debugï¼š_DEBUG_MODE=1 æ™‚æ‰æœƒè·‘ã€Œroute:listã€

substitutions:
  _SERVICE: "cicd-repo"
  _REGION: "asia-east1"

  # âœ… Artifact Registryï¼ˆä½ å·²è¨­å®š remote å° GHCRï¼‰
  # é€™è£¡æ”¾ repo baseï¼Œä¸è¦å¸¶ tag / digest
  _IMAGE: "asia-east1-docker.pkg.dev/cicd-learning-483517/cicd-learngin-registry/pancioue/cicd-repo"

  # smoke test path
  _SMOKE_PATH: "/up"

  # âœ… Debug é–‹é—œï¼šæ‰‹å‹• Run æ™‚å¡« 1 æ‰æœƒè·‘ route:list
  _DEBUG_MODE: "0"

availableSecrets:
  secretManager:
    - versionName: projects/897396234110/secrets/gcp-artifact-registry-ghcr-cicd-repo/versions/latest
      env: GHCR_PAT

options:
  logging: CLOUD_LOGGING_ONLY

steps:
  # 0) å–å¾— GHCR latest digestï¼Œä¸¦çµ„å‡º FINAL_IMAGE = _IMAGE@sha256:...
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: "Resolve digest from GHCR and write final image"
    entrypoint: bash
    secretEnv: ["GHCR_PAT"]
    args:
      - -c
      - |
        set -euo pipefail

        OWNER="pancioue"
        REPO="cicd-repo"
        TAG="latest"

        # 1) ç”¨ PAT æ› registry tokenï¼ˆscopedï¼‰
        TOKEN_JSON="$$(curl -sS \
          -H "Authorization: Bearer $$GHCR_PAT" \
          "https://ghcr.io/token?service=ghcr.io&scope=repository:$$OWNER/$$REPO:pull")"

        # ğŸ‘‰ ä¸ç”¨ pythonï¼Œç›´æ¥ç”¨ sed æŠ½ token
        REGISTRY_TOKEN="$$(echo "$$TOKEN_JSON" | sed -n 's/.*"token"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')"

        if [ -z "$$REGISTRY_TOKEN" ]; then
          echo "âŒ Failed to extract registry token from GHCR response"
          echo "$$TOKEN_JSON"
          exit 1
        fi

        # 2) å– manifest header çš„ Docker-Content-Digest
        GHCR_DIGEST="$$(curl -sSI \
          -H "Authorization: Bearer $$REGISTRY_TOKEN" \
          -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
          "https://ghcr.io/v2/$$OWNER/$$REPO/manifests/$$TAG" \
          | tr -d '\r' | awk -F': ' 'tolower($$1)=="docker-content-digest"{print $$2}')"

        if [ -z "$$GHCR_DIGEST" ]; then
          echo "âŒ Cannot read GHCR Docker-Content-Digest"
          exit 1
        fi

        echo "âœ… GHCR latest digest: $$GHCR_DIGEST"

        FINAL_IMAGE="${_IMAGE}@$$GHCR_DIGEST"
        echo "âœ… Final image ref: $$FINAL_IMAGE"
        echo -n "$$FINAL_IMAGE" > /workspace/image.txt

  # 1) è¨˜éŒ„ç›®å‰ç·šä¸Š 100% çš„ revisionï¼ˆä¾›ä½ éœ€è¦æ™‚æ‰‹å‹•å›æ»¾ç”¨ï¼‰
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: "Capture current revision"
    entrypoint: bash
    args:
      - -c
      - |
        set -e
        CURRENT_REV=$$(gcloud run services describe "${_SERVICE}" \
          --region "${_REGION}" \
          --format='value(status.traffic[0].revisionName)')
        echo "Current revision: $${CURRENT_REV}"
        echo -n "$${CURRENT_REV}" > /workspace/current_rev.txt

  # âœ… (å¯é¸) Debugï¼šåœ¨ Cloud Build ç›´æ¥è·‘ image å…§çš„ php artisan route:listï¼ˆä¸éœ€è¦ SSH/execï¼‰
  - name: gcr.io/cloud-builders/docker
    id: "Debug (optional) - php artisan route:list in image"
    entrypoint: bash
    args:
      - -c
      - |
        set -euo pipefail

        if [ "${_DEBUG_MODE}" != "1" ]; then
          echo "Skip debug routes (set _DEBUG_MODE=1 to enable)"
          exit 0
        fi

        IMAGE="$$(cat /workspace/image.txt)"
        echo "Pull image: $$IMAGE"
        docker pull "$$IMAGE"

        echo "Run: php artisan route:list"
        docker run --rm \
          -e APP_ENV=production \
          -e APP_KEY=base64:dummykeydummykeydummykeydummykeydummykeydummy= \
          "$$IMAGE" \
          sh -lc 'cd /var/www && php artisan route:list'

  # 2) no-traffic éƒ¨ç½²æ–° revisionï¼Œä¸¦åŠ  canary tag ç”¢ç”Ÿæ¸¬è©¦ URL
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: "Deploy (no-traffic) with canary tag"
    entrypoint: bash
    args:
      - -c
      - |
        set -euo pipefail
        IMAGE="$$(cat /workspace/image.txt)"

        gcloud run deploy "${_SERVICE}" \
          --image="$$IMAGE" \
          --region="${_REGION}" \
          --no-traffic \
          --tag=canary \
          --quiet

  # 2.5) éƒ¨ç½²å¾ŒåŸ·è¡Œä¸€æ¬¡æ€§ Jobï¼šphp artisan route:clear
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: "Run job: php artisan route:clear"
    entrypoint: bash
    args:
      - -c
      - |
        set -euo pipefail
        IMAGE="$$(cat /workspace/image.txt)"
        JOB_NAME="php-artisan-route-clear"

        if ! gcloud run jobs describe "$$JOB_NAME" --region "${_REGION}" --format='value(metadata.name)' >/dev/null 2>&1; then
          echo "Create job: $$JOB_NAME"
          gcloud run jobs create "$$JOB_NAME" \
            --region "${_REGION}" \
            --image "$$IMAGE" \
            --command "php" \
            --args "artisan","route:clear" \
            --quiet
        else
          echo "Job exists: $$JOB_NAME"
        fi

        echo "Execute job: $$JOB_NAME"
        gcloud run jobs execute "$$JOB_NAME" \
          --region "${_REGION}" \
          --wait \
          --quiet

  # 3) å–å¾— service URLï¼Œä¸¦ã€Œè‡ªå·±çµ„å‡ºã€canary tag URLï¼šhttps://canary---<service_id>.run.app
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: "Compute canary URL from service URL"
    entrypoint: bash
    args:
      - -c
      - |
        set -euo pipefail

        SERVICE_URL=$$(gcloud run services describe "${_SERVICE}" \
          --region "${_REGION}" \
          --format='value(status.url)')

        if [ -z "$$SERVICE_URL" ]; then
          echo "âŒ Cannot get service URL"
          exit 1
        fi

        CANARY_URL="$${SERVICE_URL/https:\/\//https:\/\/canary---}"

        echo "Service URL: $$SERVICE_URL"
        echo "Canary URL:  $$CANARY_URL"
        echo -n "$$CANARY_URL" > /workspace/canary_url.txt

  # 4) Smoke testï¼ˆæ‰“ canary tag URLï¼Œç¢ºä¿æ¸¬åˆ°æ–° revisionï¼‰
  - name: curlimages/curl:8.5.0
    id: "Smoke test"
    entrypoint: sh
    args:
      - -c
      - |
        set -e
        CANARY_URL="$$(cat /workspace/canary_url.txt)"
        echo "Hitting: $$CANARY_URL${_SMOKE_PATH}"

        for i in 1 2 3 4 5; do
          code="$$(curl -sS -o /dev/null -w "%{http_code}" "$$CANARY_URL${_SMOKE_PATH}" || true)"
          echo "Attempt $$i -> HTTP $$code"
          if [ "$$code" = "200" ]; then
            echo "âœ… Smoke test passed"
            exit 0
          fi
          sleep 2
        done

        echo "âŒ Smoke test failed"
        echo "Current 100% revision (rollback hint): $$(cat /workspace/current_rev.txt || true)"
        exit 1

  # 5) æˆåŠŸæ‰åˆ‡ 100% æµé‡åˆ° latest revision
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: "Promote traffic to latest"
    entrypoint: gcloud
    args:
      - run
      - services
      - update-traffic
      - ${_SERVICE}
      - --region=${_REGION}
      - --to-latest
      - --quiet
